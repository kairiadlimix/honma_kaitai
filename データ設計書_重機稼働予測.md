# データ設計書：重機稼働予測ダッシュボード

## 1. データモデル概要

### 1.1 ER図（概念モデル）

```
┌─────────────┐
│  重機マスタ  │
│ (Machines)  │
└──────┬──────┘
       │ 1
       │
       │ N
┌──────▼──────────────┐
│  稼働時間記録        │
│ (OperationHours)    │
└─────────────────────┘

┌─────────────┐
│  重機マスタ  │
│ (Machines)  │
└──────┬──────┘
       │ 1
       │
       │ N
┌──────▼──────────────┐
│  メンテナンス記録    │
│ (Maintenances)      │
└──────┬──────────────┘
       │ 1
       │
       │ N
┌──────▼──────────────┐
│  不調チェック項目    │
│ (FailureChecks)     │
└─────────────────────┘

┌─────────────┐
│  重機マスタ  │
│ (Machines)  │
└──────┬──────┘
       │ 1
       │
       │ N
┌──────▼──────────────┐
│  消耗品使用記録      │
│ (Consumables)       │
└─────────────────────┘
```

### 1.2 データフロー

```
┌──────────┐
│ kintone  │
│ (重機    │
│  マスタ) │
└────┬─────┘
     │ CSV/API
     ▼
┌──────────┐
│ データ    │
│ 変換      │
│ 処理      │
└────┬─────┘
     │
     ▼
┌──────────┐
│ PostgreSQL│
│ (データ   │
│  マート)  │
└────┬─────┘
     │
     ▼
┌──────────┐
│ REST API  │
│ (バック   │
│  エンド)  │
└────┬─────┘
     │
     ▼
┌──────────┐
│ React     │
│ (フロント │
│  エンド)  │
└──────────┘
```

---

## 2. テーブル設計

### 2.1 machines（重機マスタ）

**説明**: 重機の基本情報を管理

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| machine_id | VARCHAR(50) | PRIMARY KEY | 管理番号（kintoneから取得） |
| serial_number | VARCHAR(100) | UNIQUE | シリアル番号 |
| manufacturer | VARCHAR(20) | NOT NULL | メーカー（コベルコ/日立） |
| machine_class | VARCHAR(50) | NOT NULL | 重機クラス（例：SK235、ZX200） |
| model_type | VARCHAR(100) | | 型式 |
| year | INTEGER | | 年式 |
| purchase_date | DATE | | 購入年月日 |
| inspection_deadline | DATE | | 特自検期限 |
| status | VARCHAR(20) | NOT NULL | ステータス（稼働中/整備中/入庫中） |
| created_at | TIMESTAMP | DEFAULT NOW() | 作成日時 |
| updated_at | TIMESTAMP | DEFAULT NOW() | 更新日時 |

**インデックス**:
- `idx_machines_manufacturer` ON `manufacturer`
- `idx_machines_class` ON `machine_class`
- `idx_machines_status` ON `status`

**補足**:
- `machine_id`はkintoneの管理番号をそのまま使用
- `manufacturer`は「コベルコ」「日立」の2値
- `machine_class`は「SK235」「ZX200」などの形式

---

### 2.2 operation_hours（稼働時間記録）

**説明**: 重機の日次稼働時間を記録

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | BIGSERIAL | PRIMARY KEY | レコードID |
| machine_id | VARCHAR(50) | FOREIGN KEY | 管理番号 |
| date | DATE | NOT NULL | 日付 |
| operation_hours | DECIMAL(5,2) | NOT NULL | 稼働時間（時間） |
| idle_hours | DECIMAL(5,2) | DEFAULT 0 | アイドリング時間（時間） |
| total_operation_hours | DECIMAL(10,2) | | 累計稼働時間（時間） |
| created_at | TIMESTAMP | DEFAULT NOW() | 作成日時 |
| updated_at | TIMESTAMP | DEFAULT NOW() | 更新日時 |

**インデックス**:
- `idx_operation_hours_machine_date` ON (`machine_id`, `date`)
- `idx_operation_hours_date` ON `date`

**補足**:
- 1日1レコード（重機×日）
- `total_operation_hours`は累計値（更新時に再計算）
- kintoneのアワーメーター確認アプリから取得

---

### 2.3 maintenances（メンテナンス記録）

**説明**: メンテナンス実施記録

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| maintenance_id | VARCHAR(50) | PRIMARY KEY | メンテナンスID（kintoneから取得） |
| machine_id | VARCHAR(50) | FOREIGN KEY | 管理番号 |
| maintenance_date | DATE | NOT NULL | 実施日 |
| maintenance_type | VARCHAR(50) | NOT NULL | メンテナンス種別（特自検/オイル交換/部品交換など） |
| cost | DECIMAL(10,2) | DEFAULT 0 | コスト（円） |
| description | TEXT | | 実施内容 |
| created_at | TIMESTAMP | DEFAULT NOW() | 作成日時 |
| updated_at | TIMESTAMP | DEFAULT NOW() | 更新日時 |

**インデックス**:
- `idx_maintenances_machine` ON `machine_id`
- `idx_maintenances_date` ON `maintenance_date`
- `idx_maintenances_type` ON `maintenance_type`

**補足**:
- `maintenance_type`の値: 「特自検」「オイル交換」「部品交換」「その他」
- kintoneのメンテナンス記録アプリから取得

---

### 2.4 failure_checks（不調チェック項目）

**説明**: メンテナンス時の不調チェック項目

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | BIGSERIAL | PRIMARY KEY | レコードID |
| maintenance_id | VARCHAR(50) | FOREIGN KEY | メンテナンスID |
| machine_id | VARCHAR(50) | FOREIGN KEY | 管理番号 |
| check_item | VARCHAR(100) | NOT NULL | チェック項目名 |
| has_issue | BOOLEAN | NOT NULL | 不調の有無（true=不調あり） |
| severity | INTEGER | | 深刻度（1=軽微、5=深刻） |
| created_at | TIMESTAMP | DEFAULT NOW() | 作成日時 |

**インデックス**:
- `idx_failure_checks_maintenance` ON `maintenance_id`
- `idx_failure_checks_machine` ON `machine_id`
- `idx_failure_checks_issue` ON `has_issue`

**補足**:
- チェック項目の例: 「オイル漏れ」「アイドリング不安定」「異音」「振動」「排気異常」など
- 1メンテナンスで複数のチェック項目を記録可能
- `has_issue=true`の項目が故障リスクスコアの計算に使用

---

### 2.5 consumables（消耗品使用記録）

**説明**: 消耗品の使用記録

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | BIGSERIAL | PRIMARY KEY | レコードID |
| machine_id | VARCHAR(50) | FOREIGN KEY | 管理番号 |
| maintenance_id | VARCHAR(50) | FOREIGN KEY | メンテナンスID（紐付け可能） |
| consumable_type | VARCHAR(50) | NOT NULL | 消耗品種別（オイル/フィルター/グリスなど） |
| usage_date | DATE | NOT NULL | 使用日 |
| quantity | DECIMAL(10,2) | NOT NULL | 使用量 |
| unit | VARCHAR(20) | | 単位（L、個など） |
| unit_price | DECIMAL(10,2) | | 単価（円） |
| total_cost | DECIMAL(10,2) | | 総コスト（円）= quantity × unit_price |
| created_at | TIMESTAMP | DEFAULT NOW() | 作成日時 |
| updated_at | TIMESTAMP | DEFAULT NOW() | 更新日時 |

**インデックス**:
- `idx_consumables_machine` ON `machine_id`
- `idx_consumables_type` ON `consumable_type`
- `idx_consumables_date` ON `usage_date`

**補足**:
- `consumable_type`の値: 「オイル」「エアフィルター」「オイルフィルター」「グリス」「その他」
- メンテナンス記録から抽出、または別途記録
- `total_cost`は自動計算（quantity × unit_price）

---

## 3. 集計・分析用ビュー

### 3.1 v_machine_summary（重機サマリービュー）

**説明**: 重機ごとの集計情報（稼働時間、コスト、故障リスクなど）

```sql
CREATE VIEW v_machine_summary AS
SELECT 
    m.machine_id,
    m.manufacturer,
    m.machine_class,
    m.status,
    m.inspection_deadline,
    -- 稼働時間
    COALESCE(SUM(oh.operation_hours), 0) AS total_operation_hours,
    COALESCE(SUM(CASE WHEN oh.date >= DATE_TRUNC('month', CURRENT_DATE) THEN oh.operation_hours ELSE 0 END), 0) AS monthly_operation_hours,
    -- 稼働率（月次、仮に1日8時間稼働可能として計算）
    CASE 
        WHEN COUNT(DISTINCT oh.date) > 0 
        THEN (SUM(CASE WHEN oh.date >= DATE_TRUNC('month', CURRENT_DATE) THEN oh.operation_hours ELSE 0 END) / (COUNT(DISTINCT CASE WHEN oh.date >= DATE_TRUNC('month', CURRENT_DATE) THEN oh.date END) * 8.0)) * 100
        ELSE 0 
    END AS monthly_operation_rate,
    -- コスト
    COALESCE(SUM(mt.cost), 0) AS total_maintenance_cost,
    COALESCE(SUM(CASE WHEN mt.maintenance_date >= DATE_TRUNC('year', CURRENT_DATE) THEN mt.cost ELSE 0 END), 0) AS yearly_maintenance_cost,
    COALESCE(SUM(c.total_cost), 0) AS total_consumable_cost,
    COALESCE(SUM(CASE WHEN c.usage_date >= DATE_TRUNC('year', CURRENT_DATE) THEN c.total_cost ELSE 0 END), 0) AS yearly_consumable_cost,
    -- 故障リスクスコア（不調チェック項目の数から算出、★1〜5）
    CASE 
        WHEN COUNT(CASE WHEN fc.has_issue = true AND fc.created_at >= CURRENT_DATE - INTERVAL '3 months' THEN 1 END) >= 10 THEN 5
        WHEN COUNT(CASE WHEN fc.has_issue = true AND fc.created_at >= CURRENT_DATE - INTERVAL '3 months' THEN 1 END) >= 7 THEN 4
        WHEN COUNT(CASE WHEN fc.has_issue = true AND fc.created_at >= CURRENT_DATE - INTERVAL '3 months' THEN 1 END) >= 4 THEN 3
        WHEN COUNT(CASE WHEN fc.has_issue = true AND fc.created_at >= CURRENT_DATE - INTERVAL '3 months' THEN 1 END) >= 2 THEN 2
        ELSE 1
    END AS failure_risk_score,
    -- 最終メンテナンス日
    MAX(mt.maintenance_date) AS last_maintenance_date
FROM machines m
LEFT JOIN operation_hours oh ON m.machine_id = oh.machine_id
LEFT JOIN maintenances mt ON m.machine_id = mt.machine_id
LEFT JOIN failure_checks fc ON mt.maintenance_id = fc.maintenance_id
LEFT JOIN consumables c ON m.machine_id = c.machine_id
GROUP BY m.machine_id, m.manufacturer, m.machine_class, m.status, m.inspection_deadline;
```

---

### 3.2 v_monthly_operation（月次稼働集計ビュー）

**説明**: 重機×月の稼働時間集計

```sql
CREATE VIEW v_monthly_operation AS
SELECT 
    machine_id,
    DATE_TRUNC('month', date) AS month,
    SUM(operation_hours) AS total_operation_hours,
    SUM(idle_hours) AS total_idle_hours,
    COUNT(DISTINCT date) AS operation_days,
    AVG(operation_hours) AS avg_daily_operation_hours
FROM operation_hours
GROUP BY machine_id, DATE_TRUNC('month', date);
```

---

### 3.3 v_monthly_cost（月次コスト集計ビュー）

**説明**: 重機×月のコスト集計

```sql
CREATE VIEW v_monthly_cost AS
SELECT 
    machine_id,
    DATE_TRUNC('month', COALESCE(maintenance_date, usage_date)) AS month,
    COALESCE(SUM(mt.cost), 0) AS maintenance_cost,
    COALESCE(SUM(c.total_cost), 0) AS consumable_cost,
    COALESCE(SUM(mt.cost), 0) + COALESCE(SUM(c.total_cost), 0) AS total_cost
FROM machines m
LEFT JOIN maintenances mt ON m.machine_id = mt.machine_id
LEFT JOIN consumables c ON m.machine_id = c.machine_id
GROUP BY machine_id, DATE_TRUNC('month', COALESCE(maintenance_date, usage_date));
```

---

## 4. データ取得・変換処理

### 4.1 kintoneからのデータ取得

#### 4.1.1 重機マスタ取得

**kintone API エンドポイント**: `/k/v1/records.json`

**パラメータ**:
- `app`: 重機マスタアプリID
- `fields`: 必要なフィールドコード

**マッピング**:
```
kintoneフィールド → データベースカラム
管理番号 → machine_id
シリアル番号 → serial_number
メーカー → manufacturer
重機クラス → machine_class
型式 → model_type
年式 → year
購入年月 → purchase_date
特自検期限 → inspection_deadline
ステータス → status
```

#### 4.1.2 メンテナンス記録取得

**マッピング**:
```
kintoneフィールド → データベースカラム
レコード番号 → maintenance_id
管理番号 → machine_id
実施日 → maintenance_date
メンテナンス種別 → maintenance_type
コスト → cost
実施内容 → description
```

**不調チェック項目の処理**:
- kintoneの「不調チェック項目」フィールド（複数選択）から抽出
- 各チェック項目を`failure_checks`テーブルに1レコードずつ挿入

#### 4.1.3 稼働時間データ取得

**マッピング**:
```
kintoneフィールド → データベースカラム
管理番号 → machine_id
日付 → date
稼働時間 → operation_hours
アイドリング時間 → idle_hours
累計稼働時間 → total_operation_hours
```

#### 4.1.4 消耗品データ取得

**マッピング**:
```
kintoneフィールド → データベースカラム
管理番号 → machine_id
メンテナンスID → maintenance_id（紐付け）
消耗品種別 → consumable_type
使用日 → usage_date
使用量 → quantity
単位 → unit
単価 → unit_price
```

---

### 4.2 データ変換・正規化処理

#### 4.2.1 データクリーニング

- **文字列の正規化**: 前後の空白削除、全角/半角統一
- **日付フォーマット統一**: kintoneの日付形式 → PostgreSQL DATE型
- **数値の検証**: 負の値チェック、異常値チェック
- **重複チェック**: 既存レコードとの重複確認

#### 4.2.2 データ変換ロジック

**メーカーの正規化**:
```python
def normalize_manufacturer(value):
    if 'コベルコ' in value or 'KOBELCO' in value.upper():
        return 'コベルコ'
    elif '日立' in value or 'HITACHI' in value.upper():
        return '日立'
    else:
        return value
```

**重機クラスの抽出**:
```python
def extract_machine_class(serial_number, model_type):
    # SKで始まる → コベルコ
    if serial_number.startswith('SK'):
        return serial_number[:5]  # SK235など
    # ZXで始まる → 日立
    elif serial_number.startswith('ZX'):
        return serial_number[:5]  # ZX200など
    else:
        return model_type
```

---

## 5. データ更新戦略

### 5.1 更新頻度

- **PoC段階**: 1日1回（深夜バッチ）
- **本番環境**: 2〜3時間おき（将来的）

### 5.2 更新処理フロー

```
1. kintone APIからデータ取得
2. データ変換・正規化
3. 既存データとの比較（差分検出）
4. 差分のみ更新（UPSERT処理）
5. 集計ビューの再計算（必要に応じて）
6. ログ記録
```

### 5.3 UPSERT処理

**重機マスタ**:
```sql
INSERT INTO machines (machine_id, serial_number, ...)
VALUES (?, ?, ...)
ON CONFLICT (machine_id) 
DO UPDATE SET 
    serial_number = EXCLUDED.serial_number,
    status = EXCLUDED.status,
    updated_at = NOW();
```

**稼働時間記録**:
```sql
INSERT INTO operation_hours (machine_id, date, operation_hours, ...)
VALUES (?, ?, ...)
ON CONFLICT (machine_id, date)
DO UPDATE SET 
    operation_hours = EXCLUDED.operation_hours,
    updated_at = NOW();
```

---

## 6. サンプルデータ設計

### 6.1 PoC用サンプルデータ

**重機マスタ**: 15〜20台程度
- コベルコ: 8〜10台（SK235、SK200など）
- 日立: 7〜10台（ZX200、ZX160など）

**稼働時間データ**: 過去6ヶ月分
- 1日あたり0〜10時間の稼働時間
- 稼働率: 30〜70%程度

**メンテナンス記録**: 過去6ヶ月分
- 1重機あたり月1〜2回程度
- コスト: 1回あたり5,000〜50,000円

**消耗品データ**: 過去6ヶ月分
- オイル: 月1〜2回、10〜50L
- フィルター: 月0.5回程度

---

## 7. パフォーマンス最適化

### 7.1 インデックス戦略

- 主キー、外部キーに自動インデックス
- 頻繁に検索されるカラムにインデックス
- 複合インデックス（machine_id + dateなど）

### 7.2 クエリ最適化

- 集計ビューを活用
- 不要なJOINを避ける
- LIMIT句で件数制限

### 7.3 キャッシュ戦略

- 集計結果をRedis等にキャッシュ（将来拡張）
- フロントエンド側でAPIレスポンスをキャッシュ

---

## 8. データ品質管理

### 8.1 バリデーションルール

- **必須項目チェック**: machine_id、dateなど
- **データ型チェック**: 数値、日付の形式
- **範囲チェック**: 稼働時間が0〜24時間以内など
- **参照整合性**: 外部キーの存在確認

### 8.2 エラーハンドリング

- データ取得エラー時のリトライ処理
- 不正データのログ記録
- エラー通知（Slack、メールなど）

---

## 9. セキュリティ

### 9.1 データアクセス制御

- データベースユーザーの権限分離
- 読み取り専用ユーザーでAPI接続
- パスワード管理（環境変数、シークレット管理）

### 9.2 データマスキング（将来拡張）

- 本番データ使用時は個人情報・機密情報をマスキング
- サンプルデータは匿名化

---

## 10. 移行・バックアップ

### 10.1 データ移行

- kintoneからの初回データ取得
- 既存データの移行（必要に応じて）

### 10.2 バックアップ戦略

- 日次バックアップ（PoC段階）
- 本番環境では自動バックアップ設定

